<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- 부트스트랩 api -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
    <!-- footer css -->
    <link href="/css/footer.css" rel="stylesheet">
    <script src="/js/nullPage.js"></script>
    <script th:inline="javascript">
        // 컨트롤러에서 모델로 바인딩한 에러 체크값
        let error = [[${error}]];
        // 컨트롤러에서 모델로 바인딩한 에러 메세지
        let errorMessage = [[${errorMessage}]];

        // 에러 체크값이 true일 경우 에러 알림창 등장
        if ( error == "true" ) {
            alert(errorMessage);
            location.href = "/business/";
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="row" style="width: 100%; height: 100px;">

        </div>
        <div class="row" style="width: 100%; height: 100px;">

        </div>
        <div class="row" style="width: 100%; height: 500px;">
            <div class="col-6" style="height: 100%;">
                <div style="width: 100%; height: 20%;">
                    사진
                </div>
                <div style="width: 100%; height: 80%;">
                    <div id="carouselExample" class="carousel slide" data-bs-ride="true" style="height: 100%; width: 100%;">
                        <div class="carousel-inner" style="height: 100%; width: 100%;">
                            <th:block th:each="businessImage : ${businessImageList}">
                                    <th:block th:if="${businessImageStat.count} == 1">
                                        <form method="post" action="/business/imageDelete/" class="carousel-item active" style="height: 100%; width: 100%;">
                                            <img th:src="@{/businessImage/} + ${businessImage.image}" class="d-block w-100" alt="..." style="height: 100%; width: 100%;">
                                            <input type="hidden" name="idx" th:value="${businessImage.idx}">
                                            <div class="carousel-caption d-none d-md-block">
                                                <input class="btn btn-outline-light" type="submit" value="사진 삭제">
                                            </div>
                                        </form>
                                    </th:block>
                                    <th:block th:if="${businessImageStat.count} != 1">
                                        <form method="post" action="/business/imageDelete/" class="carousel-item"  style="height: 100%; width: 100%;">
                                            <img th:src="@{/businessImage/} + ${businessImage.image}" class="d-block w-100" alt="..." style="height: 100%; width: 100%;">
                                            <input type="hidden" name="idx" th:value="${businessImage.idx}">
                                            <div class="carousel-caption d-none d-md-block">
                                                <input class="btn btn-outline-light" type="submit" value="사진 삭제">
                                            </div>
                                        </form>
                                    </th:block>
                            </th:block>
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExample" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselExample" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-6" style="height: 100%;">
                <div style="width: 100%; height: 20%;">
                    사진 추가
                </div>
                <div style="width: 100%; height: 80%;">
                    <form style="width: 100%; height: 100%;" method="post" enctype="multipart/form-data" action="/business/imageAdd/">
                        <input type="hidden" th:value="${business.idx}" id="businessIdx" name="businessIdx">
                        <div class="row" style="width: 100%; height: 90%;">
                            <img id="previewProfileImage" style="width: 100%; height: 100%;">
                        </div>
                        <div class="row" style="width: 100%; height: 10%;">
                            <div class="col-6">
                                <input type="file" id="imageFile"  name="imageFile" onchange="previewImage();">
                            </div>
                            <div class="col-6">
                                <input type="submit" value="사진 추가">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <h1>사업자 메인 페이지</h1>
    <div>
        <div th:text="${id}"></div>
    </div>
    <div>
        <div th:text="${business.placeName}"></div>
    </div>
    <div>
        <div>
<!--            <form method="post" enctype="multipart/form-data" action="/business/imageAdd/">-->
<!--                <input type="hidden" th:value="${business.idx}" id="businessIdx" name="businessIdx">-->
<!--                <input type="file" id="imageFile"  name="imageFile" onchange="previewImage();">-->
<!--                <input type="submit" value="사진 추가">-->
<!--            </form>-->
        </div>
    </div>
    <div>
        <input type="button" value="방 추가" onclick="location.href='/business/roomAddPage/'">
    </div>
    <div th:each="room : ${roomList}" style="border:1px solid black;">
        <form action="/business/roomUpdatePage/" method="GET">
            <div th:text="${room.roomName}"></div>
            <div th:text="${room.price}"></div>
            <input type="hidden" th:value="${room.idx}" id="idx" name="idx">
            <div>
                <input type="submit" value="방 수정">
            </div>
            <div>
                <input type="button" value="상세보기" th:onclick="roomPost([[${room.idx}]])">
            </div>
            <div>
                <input type="button" value="방 삭제" onclick="roomDelete();">
            </div>
        </form>
    </div>
    <div sec:authorize="isAuthenticated()">
        <input type="button" value="로그아웃" onclick="location.href='/logout/'">
    </div>
</body>
<script src="/js/httpRequest.js"></script>
<script>
    // 방 삭제하기
    function roomDelete(){
        let idx = document.getElementById("idx").value;
        let url = "/business/roomDelete/"
        let param = "idx=" + idx;
        sendRequest(url, param, resultDelete, "GET");
    }
    function resultDelete(){
        if ( xhr.readyState == 4 && xhr.status == 200 ) {
            let data = xhr.responseText;

            if (data == "no") {
                alert("방 삭제 실패");
            } else {
                alert("방 삭제 성공");
                location.reload();
            }
        }
    }
</script>
<script>
    // 이미지 미리보기
    function previewImage() {
        const previewProfileImage = document.getElementById("previewProfileImage");
        const file = document.getElementById("imageFile").files[0];
        const reader = new FileReader();

        reader.addEventListener("load", function () {
            previewProfileImage.src = reader.result;
        }, false);

        if (file) {
            reader.readAsDataURL(file);
        }
    }
</script>
<script>
    // 방 상세보기 페이지로 이동
    function roomPost(idx){
        let roomIdx = idx;
        location.href="/business/roomPostPage/?idx=" + idx;
    }
</script>
</html>